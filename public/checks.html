<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write Checks - Expense Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-cream: #faf8f5;
            --bg-white: #ffffff;
            --bg-paper: #fffef9;
            --border-gold: #c9a962;
            --border-light: #e8e4dc;
            --text-navy: #1a2744;
            --text-dark: #2d3748;
            --text-muted: #6b7280;
            --accent-green: #1a5d3a;
            --accent-burgundy: #7a2e3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-cream);
            min-height: 100vh;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4cfc5' fill-opacity='0.15'%3E%3Cpath d='M20 0v40M0 20h40'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Header */
        .page-header {
            background: var(--bg-white);
            border-bottom: 3px solid var(--border-gold);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            font-weight: 600;
            color: var(--text-navy);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title::before,
        .page-title::after {
            content: '‚ú¶';
            color: var(--border-gold);
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 4px;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
            border: 2px solid var(--accent-green);
        }

        .btn-primary:hover {
            background: #155a30;
            border-color: #155a30;
        }

        .btn-outline {
            background: transparent;
            color: var(--text-navy);
            border: 2px solid var(--text-navy);
        }

        .btn-outline:hover {
            background: var(--text-navy);
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            border: 2px solid #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        /* Main Layout */
        .main-container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 30px 40px;
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 40px;
        }

        /* Left Column */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Bank Selection */
        .bank-selection {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px 24px;
        }

        .bank-selection label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .bank-select {
            width: 100%;
            max-width: 400px;
            padding: 12px 44px 12px 14px;
            font-size: 15px;
            font-family: 'Source Sans 3', sans-serif;
            color: var(--text-navy);
            background: var(--bg-cream);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231a2744' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            cursor: pointer;
        }

        .bank-select:focus {
            outline: none;
            border-color: var(--border-gold);
        }

        /* Check Paper */
        .check-paper {
            background: var(--bg-paper);
            border: 2px solid var(--border-gold);
            border-radius: 2px;
            padding: 30px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .check-paper::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 1px solid var(--border-light);
            pointer-events: none;
        }

        .check-inner {
            position: relative;
            z-index: 1;
        }

        /* Check Header Row */
        .check-header-row {
            display: flex;
            justify-content: flex-end;
            gap: 30px;
            margin-bottom: 24px;
        }

        .check-field-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .check-field-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .check-field-input {
            font-family: 'Source Sans 3', sans-serif;
            font-size: 15px;
            color: var(--text-navy);
            border: none;
            border-bottom: 1px solid var(--border-light);
            background: transparent;
            padding: 6px 10px;
            transition: border-color 0.2s;
        }

        .check-field-input:focus {
            outline: none;
            border-bottom-color: var(--border-gold);
        }

        .check-field-input.number-input {
            width: 80px;
            text-align: center;
        }

        .check-field-input.date-input {
            width: 140px;
        }

        /* Pay To Line */
        .payto-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .payto-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .payto-input {
            flex: 1;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 16px;
            color: var(--text-navy);
            border: none;
            border-bottom: 1px solid #888;
            background: transparent;
            padding: 8px 4px;
        }

        .payto-input:focus {
            outline: none;
            border-bottom-color: var(--border-gold);
        }

        .amount-box {
            border: 2px solid var(--text-navy);
            padding: 8px 12px;
            min-width: 120px;
            display: flex;
            align-items: center;
        }

        .amount-box-symbol {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-navy);
            margin-right: 4px;
        }

        .amount-box-input {
            font-family: 'Source Sans 3', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-navy);
            border: none;
            background: transparent;
            width: 100px;
            text-align: right;
        }

        .amount-box-input:focus {
            outline: none;
        }

        /* Amount Words */
        .amount-words-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 20px;
        }

        .amount-words-input {
            flex: 1;
            font-family: 'Cormorant Garamond', serif;
            font-size: 15px;
            font-style: italic;
            color: var(--text-dark);
            border: none;
            border-bottom: 1px solid #888;
            background: transparent;
            padding: 6px 4px;
        }

        .amount-words-input:focus {
            outline: none;
        }

        .amount-words-suffix {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-navy);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Address Section */
        .address-section {
            margin-bottom: 20px;
        }

        .address-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .address-box {
            width: 280px;
            height: 72px;
            border: 1px solid var(--border-light);
            background: rgba(255,255,255,0.5);
            padding: 8px 10px;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 13px;
            color: var(--text-navy);
            resize: none;
            line-height: 1.5;
        }

        .address-box:focus {
            outline: none;
            border-color: var(--border-gold);
        }

        /* Memo Line */
        .memo-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .memo-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .memo-input {
            flex: 1;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 14px;
            color: var(--text-dark);
            border: none;
            border-bottom: 1px solid #ccc;
            background: transparent;
            padding: 6px 4px;
        }

        .memo-input:focus {
            outline: none;
            border-bottom-color: var(--border-gold);
        }

        /* Additional Options */
        .additional-section {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 24px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .option-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .option-select {
            width: 100%;
            padding: 12px 44px 12px 14px;
            font-size: 14px;
            font-family: 'Source Sans 3', sans-serif;
            color: var(--text-navy);
            background: var(--bg-cream);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231a2744' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            cursor: pointer;
        }

        .option-select:focus {
            outline: none;
            border-color: var(--border-gold);
        }

        /* Checkbox */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .custom-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--accent-green);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .custom-checkbox.checked {
            background: var(--accent-green);
        }

        .custom-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--text-dark);
            cursor: pointer;
        }

        /* Form Footer */
        .form-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
        }

        /* Sidebar */
        .sidebar-card {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            overflow: hidden;
            height: fit-content;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--accent-burgundy), #5a1f2b);
            color: white;
            padding: 16px 20px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .sidebar-body {
            padding: 20px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 16px 12px;
            background: var(--bg-cream);
            border-radius: 6px;
        }

        .stat-number {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 700;
        }

        .stat-number.pending-num {
            color: var(--accent-burgundy);
        }

        .stat-number.amount-num {
            color: var(--accent-green);
            font-size: 24px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }

        .filter-tab {
            flex: 1;
            padding: 10px 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            background: var(--bg-cream);
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-tab:hover {
            background: var(--border-light);
        }

        .filter-tab.active {
            background: var(--accent-green);
            color: white;
        }

        /* Checks List */
        .checks-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .check-item {
            padding: 14px 0;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background 0.15s;
        }

        .check-item:hover {
            background: var(--bg-cream);
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .check-item-number {
            font-weight: 600;
            color: var(--text-navy);
        }

        .check-item-amount {
            font-weight: 600;
            color: var(--text-navy);
        }

        .check-item-payee {
            font-size: 13px;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .check-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-badge.printed {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status-badge.cleared {
            background: #d1fae5;
            color: #059669;
        }

        .status-badge.void {
            background: #fee2e2;
            color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Print Stubs (hidden on screen) */
        .print-stub {
            display: none;
        }

        /* Print Styles */
        @media print {
            @page {
                size: 8.5in 11in;
                margin: 0;
            }

            body {
                background: white;
                background-image: none;
            }

            .page-header,
            .sidebar-card,
            .additional-section,
            .form-footer,
            .bank-selection {
                display: none !important;
            }

            .main-container {
                display: block;
                padding: 0;
                max-width: none;
            }

            .left-column {
                gap: 0;
            }

            /* Check Section - 3.5 inches */
            .check-paper {
                position: absolute;
                top: 0;
                left: 0;
                width: 8.5in;
                height: 3.5in;
                padding: 0.25in 0.5in;
                border: none;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px dashed #999;
            }

            .check-paper::before {
                display: none;
            }

            /* Print Stubs */
            .print-stub {
                display: block;
                position: absolute;
                left: 0;
                width: 8.5in;
                padding: 0.25in 0.5in;
                font-family: 'Source Sans 3', Arial, sans-serif;
            }

            .print-stub-middle {
                top: 3.5in;
                height: 3.5in;
                border-bottom: 1px dashed #999;
            }

            .print-stub-bottom {
                top: 7in;
                height: 4in;
            }

            .stub-header {
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: #666;
                margin-bottom: 16px;
                padding-bottom: 8px;
                border-bottom: 1px solid #ddd;
            }

            .stub-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                font-size: 13px;
            }

            .stub-label {
                color: #666;
            }

            .stub-value {
                color: #1a1a1a;
                font-weight: 500;
            }

            /* Hide input borders for print */
            .check-field-input,
            .payto-input,
            .amount-box-input,
            .amount-words-input,
            .memo-input,
            .address-box {
                border: none !important;
            }
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* ===== Two-Column Category Dropdown ===== */
        .category-dropdown-wrapper {
            position: relative;
        }

        .category-trigger {
            width: 100%;
            padding: 12px 44px 12px 14px;
            font-size: 14px;
            font-family: 'Source Sans 3', sans-serif;
            color: var(--text-navy);
            background: var(--bg-cream);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .category-trigger::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            border: solid var(--text-navy);
            border-width: 0 2px 2px 0;
            padding: 3px;
            transform: translateY(-70%) rotate(45deg);
            transition: transform 0.2s;
        }

        .category-trigger.open::after {
            transform: translateY(-30%) rotate(-135deg);
        }

        .category-trigger:hover {
            border-color: var(--border-gold);
        }

        .category-trigger.open {
            border-color: var(--accent-green);
        }

        .category-trigger-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .category-trigger-text.placeholder {
            color: var(--text-muted);
        }

        .category-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            overflow: hidden;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .category-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .category-list-panel {
            width: 150px;
            background: #1a2744;
            padding: 8px;
            max-height: 320px;
            overflow-y: auto;
        }

        .category-list-panel::-webkit-scrollbar {
            width: 6px;
        }

        .category-list-panel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }

        .category-list-panel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .category-btn {
            width: 100%;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 500;
            color: rgba(255,255,255,0.7);
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }

        .category-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .category-btn.active {
            background: var(--accent-green);
            color: white;
        }

        .category-btn-icon {
            font-size: 14px;
        }

        .subcategory-panel {
            flex: 1;
            padding: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .subcategory-panel::-webkit-scrollbar {
            width: 6px;
        }

        .subcategory-panel::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .subcategory-panel::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .subcategory-header {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
            padding: 8px 12px 4px;
        }

        .subcategory-option {
            padding: 10px 12px;
            font-size: 13px;
            color: #444;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subcategory-option:hover {
            background: #f5f5f5;
        }

        .subcategory-option.selected {
            background: #e8f5e9;
            color: var(--accent-green);
            font-weight: 600;
        }

        .subcategory-option.selected::before {
            content: '‚úì';
            color: var(--accent-green);
            font-weight: bold;
            margin-right: 4px;
        }

        .subcategory-option-icon {
            font-size: 14px;
        }

        .subcategory-empty {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }

        /* Mobile responsive for dropdown */
        @media (max-width: 500px) {
            .category-menu {
                width: calc(100vw - 80px);
                max-width: 360px;
            }

            .category-list-panel {
                width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="page-header">
        <h1 class="page-title">Write Checks</h1>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="window.print()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6z"/></svg>
                Print
            </button>
            <button class="btn btn-primary" onclick="resetForm()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                New Check
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Left Column -->
        <div class="left-column">
            <!-- Bank Selection -->
            <div class="bank-selection">
                <label for="bank-account">Bank Account</label>
                <select id="bank-account" class="bank-select" onchange="updateNextCheckNumber()">
                    <option value="">Select bank account...</option>
                </select>
            </div>

            <!-- Check Paper -->
            <div class="check-paper">
                <div class="check-inner">
                    <!-- Header Row: Check # and Date -->
                    <div class="check-header-row">
                        <div class="check-field-group">
                            <span class="check-field-label">No.</span>
                            <input type="text" id="check-number" class="check-field-input number-input" placeholder="1001" oninput="updatePreview()">
                        </div>
                        <div class="check-field-group">
                            <span class="check-field-label">Date</span>
                            <input type="date" id="check-date" class="check-field-input date-input" oninput="updatePreview()">
                        </div>
                    </div>

                    <!-- Pay To Line -->
                    <div class="payto-row">
                        <span class="payto-label">Pay to the order of</span>
                        <input type="text" id="check-payee" class="payto-input" placeholder="Enter payee name" oninput="updatePreview()">
                        <div class="amount-box">
                            <span class="amount-box-symbol">$</span>
                            <input type="number" id="check-amount" class="amount-box-input" placeholder="0.00" step="0.01" min="0" oninput="updateAmountWords()">
                        </div>
                    </div>

                    <!-- Amount in Words -->
                    <div class="amount-words-row">
                        <input type="text" id="amount-words" class="amount-words-input" readonly placeholder="Zero and 00/100">
                        <span class="amount-words-suffix">Dollars</span>
                    </div>

                    <!-- Address Section -->
                    <div class="address-section">
                        <div class="address-label">Address</div>
                        <textarea id="check-address" class="address-box" placeholder="Name&#10;Street Address&#10;City, State ZIP"></textarea>
                    </div>

                    <!-- Memo Line -->
                    <div class="memo-row">
                        <span class="memo-label">Memo</span>
                        <input type="text" id="check-memo" class="memo-input" placeholder="Invoice number, description, etc.">
                    </div>
                </div>
            </div>

            <!-- Additional Options -->
            <div class="additional-section">
                <div class="section-title">Additional Options</div>
                <form id="check-form">
                    <input type="hidden" id="check-id">

                    <div class="options-grid">
                        <div class="option-group">
                            <label>Category</label>
                            <div class="category-dropdown-wrapper" id="category-dropdown">
                                <input type="hidden" id="check-category" value="">
                                <div class="category-trigger" onclick="toggleCategoryDropdown()">
                                    <span class="category-trigger-text placeholder" id="category-trigger-text">Select category</span>
                                </div>
                                <div class="category-menu" id="category-menu">
                                    <div class="category-list-panel" id="category-list-panel">
                                        <!-- Parent categories will be rendered here -->
                                    </div>
                                    <div class="subcategory-panel" id="subcategory-panel">
                                        <div class="subcategory-empty">Select a category</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="option-group">
                            <label for="check-status">Status</label>
                            <select id="check-status" class="option-select">
                                <option value="pending">Pending</option>
                                <option value="printed">Printed</option>
                                <option value="cleared">Cleared</option>
                                <option value="void">Void</option>
                            </select>
                        </div>
                    </div>

                    <div class="checkbox-row">
                        <div class="custom-checkbox checked" id="transaction-checkbox" onclick="toggleCheckbox(this)"></div>
                        <input type="hidden" id="create-transaction" value="1">
                        <span class="checkbox-label" onclick="toggleCheckbox(document.getElementById('transaction-checkbox'))">Record as transaction</span>
                    </div>

                    <div class="form-footer">
                        <button type="button" class="btn btn-danger" id="delete-btn" onclick="deleteCheck()" style="display:none;margin-right:auto;">Delete</button>
                        <button type="button" class="btn btn-outline" onclick="resetForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Check</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar-card">
            <div class="sidebar-header">Check Register</div>
            <div class="sidebar-body">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number pending-num" id="pending-count">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number amount-num" id="pending-amount">$0</div>
                        <div class="stat-label">Outstanding</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterChecks('', this)">All</button>
                    <button class="filter-tab" onclick="filterChecks('pending', this)">Pending</button>
                    <button class="filter-tab" onclick="filterChecks('cleared', this)">Cleared</button>
                </div>

                <!-- Checks List -->
                <div class="checks-list" id="checks-list">
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div>No checks found</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Print Stubs (visible only when printing) -->
    <div class="print-stub print-stub-middle">
        <div class="stub-header">Payment Stub - Payee Copy</div>
        <div class="stub-row">
            <span class="stub-label">Date:</span>
            <span class="stub-value" id="stub1-date"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Check No:</span>
            <span class="stub-value" id="stub1-number"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Pay To:</span>
            <span class="stub-value" id="stub1-payee"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Amount:</span>
            <span class="stub-value" id="stub1-amount"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Memo:</span>
            <span class="stub-value" id="stub1-memo"></span>
        </div>
    </div>

    <div class="print-stub print-stub-bottom">
        <div class="stub-header">Payment Stub - Office Copy</div>
        <div class="stub-row">
            <span class="stub-label">Date:</span>
            <span class="stub-value" id="stub2-date"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Check No:</span>
            <span class="stub-value" id="stub2-number"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Pay To:</span>
            <span class="stub-value" id="stub2-payee"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Amount:</span>
            <span class="stub-value" id="stub2-amount"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Memo:</span>
            <span class="stub-value" id="stub2-memo"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Address:</span>
            <span class="stub-value" id="stub2-address"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Category:</span>
            <span class="stub-value" id="stub2-category"></span>
        </div>
        <div class="stub-row">
            <span class="stub-label">Account:</span>
            <span class="stub-value" id="stub2-account"></span>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = (() => {
            const pathParts = window.location.pathname.split('/');
            const appFolder = pathParts.find((part, index) => index > 0 && part !== '' && part !== 'public');
            return appFolder ? '/' + appFolder + '/api/v1' : '/api/v1';
        })();
        const USER_ID = localStorage.getItem('expense_tracker_user') || 1;

        // State
        let checksData = null;
        let accounts = [];
        let categories = [];
        let nextCheckNumbers = {};
        let currentFilter = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('check-date').value = new Date().toISOString().split('T')[0];
            loadData();
            document.getElementById('check-form').addEventListener('submit', saveCheck);
        });

        // Populate stubs before printing
        window.addEventListener('beforeprint', () => {
            const date = document.getElementById('check-date').value;
            const number = document.getElementById('check-number').value;
            const payee = document.getElementById('check-payee').value;
            const amount = document.getElementById('check-amount').value;
            const memo = document.getElementById('check-memo').value;
            const address = document.getElementById('check-address').value;
            const category = document.getElementById('check-category').selectedOptions[0]?.text || '';
            const account = document.getElementById('bank-account').selectedOptions[0]?.text || '';

            const formattedDate = date ? new Date(date).toLocaleDateString() : '';
            const formattedAmount = amount ? '$' + parseFloat(amount).toFixed(2) : '';

            // Stub 1 (Payee Copy)
            document.getElementById('stub1-date').textContent = formattedDate;
            document.getElementById('stub1-number').textContent = number;
            document.getElementById('stub1-payee').textContent = payee;
            document.getElementById('stub1-amount').textContent = formattedAmount;
            document.getElementById('stub1-memo').textContent = memo;

            // Stub 2 (Office Copy)
            document.getElementById('stub2-date').textContent = formattedDate;
            document.getElementById('stub2-number').textContent = number;
            document.getElementById('stub2-payee').textContent = payee;
            document.getElementById('stub2-amount').textContent = formattedAmount;
            document.getElementById('stub2-memo').textContent = memo;
            document.getElementById('stub2-address').textContent = address.replace(/\n/g, ', ');
            document.getElementById('stub2-category').textContent = category;
            document.getElementById('stub2-account').textContent = account;
        });

        // Load all data
        async function loadData() {
            await Promise.all([loadChecks(), loadAccounts(), loadCategories()]);
        }

        // Load checks
        async function loadChecks() {
            let url = `${API_BASE}/checks/?user_id=${USER_ID}`;
            if (currentFilter) url += `&status=${currentFilter}`;

            try {
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    checksData = result.data;
                    nextCheckNumbers = result.data.next_check_numbers || {};
                    renderChecks();
                    updateSummary();
                }
            } catch (error) {
                console.error('Error loading checks:', error);
            }
        }

        // Load accounts
        async function loadAccounts() {
            try {
                const response = await fetch(`${API_BASE}/accounts/?user_id=${USER_ID}`);
                const result = await response.json();

                if (result.success) {
                    accounts = result.data.accounts.filter(a => a.account_type === 'checking');
                    const select = document.getElementById('bank-account');
                    select.innerHTML = '<option value="">Select bank account...</option>' +
                        accounts.map(a => `<option value="${a.id}">${a.account_name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories/?user_id=${USER_ID}`);
                const result = await response.json();

                if (result.success) {
                    categories = result.data.categories.filter(c => c.category_type === 'expense');
                    renderCategoryDropdown();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // ===== Two-Column Category Dropdown Functions =====
        let activeCategoryId = null;
        let selectedCategoryId = null;

        function renderCategoryDropdown() {
            // Build hierarchy: find parent categories (no parent_id)
            const parentCategories = categories.filter(c => !c.parent_id);
            const panel = document.getElementById('category-list-panel');

            panel.innerHTML = parentCategories.map(cat => `
                <button type="button" class="category-btn" data-id="${cat.id}" onclick="selectParentCategory(${cat.id}, event)">
                    <span class="category-btn-icon">${cat.icon || 'üìÅ'}</span>
                    <span>${cat.name}</span>
                </button>
            `).join('');

            // If there's only one parent, auto-select it
            if (parentCategories.length === 1) {
                selectParentCategory(parentCategories[0].id);
            }
        }

        function selectParentCategory(parentId, event) {
            if (event) event.stopPropagation();

            activeCategoryId = parentId;

            // Update button states
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.id) === parentId);
            });

            // Get children of this parent
            const children = categories.filter(c => c.parent_id === parentId);
            const parent = categories.find(c => c.id === parentId);
            const subPanel = document.getElementById('subcategory-panel');

            if (children.length === 0) {
                // No children - show parent as selectable option
                subPanel.innerHTML = `
                    <div class="subcategory-header">${parent?.name || 'Category'}</div>
                    <div class="subcategory-option ${selectedCategoryId === parentId ? 'selected' : ''}"
                         data-id="${parentId}"
                         onclick="selectSubcategory(${parentId}, '${(parent?.icon || 'üìÅ').replace(/'/g, "\\'")}', '${(parent?.name || '').replace(/'/g, "\\'")}')">
                        <span class="subcategory-option-icon">${parent?.icon || 'üìÅ'}</span>
                        <span>${parent?.name}</span>
                    </div>
                `;
            } else {
                // Has children - show them
                subPanel.innerHTML = `
                    <div class="subcategory-header">${parent?.name || 'Subcategories'}</div>
                    ${children.map(child => `
                        <div class="subcategory-option ${selectedCategoryId === child.id ? 'selected' : ''}"
                             data-id="${child.id}"
                             onclick="selectSubcategory(${child.id}, '${(child.icon || 'üìÅ').replace(/'/g, "\\'")}', '${(child.name || '').replace(/'/g, "\\'")}')">
                            <span class="subcategory-option-icon">${child.icon || 'üìÅ'}</span>
                            <span>${child.name}</span>
                        </div>
                    `).join('')}
                `;
            }
        }

        function selectSubcategory(categoryId, icon, name) {
            selectedCategoryId = categoryId;
            document.getElementById('check-category').value = categoryId;

            // Update trigger text
            const triggerText = document.getElementById('category-trigger-text');
            triggerText.textContent = `${icon} ${name}`;
            triggerText.classList.remove('placeholder');

            // Update selected state
            document.querySelectorAll('.subcategory-option').forEach(opt => {
                opt.classList.toggle('selected', parseInt(opt.dataset.id) === categoryId);
            });

            // Close dropdown
            closeCategoryDropdown();
        }

        function toggleCategoryDropdown() {
            const trigger = document.querySelector('.category-trigger');
            const menu = document.getElementById('category-menu');
            const isOpen = menu.classList.contains('open');

            if (isOpen) {
                closeCategoryDropdown();
            } else {
                trigger.classList.add('open');
                menu.classList.add('open');
            }
        }

        function closeCategoryDropdown() {
            document.querySelector('.category-trigger').classList.remove('open');
            document.getElementById('category-menu').classList.remove('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('category-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                closeCategoryDropdown();
            }
        });

        function setCategoryValue(categoryId) {
            if (!categoryId) {
                selectedCategoryId = null;
                document.getElementById('check-category').value = '';
                const triggerText = document.getElementById('category-trigger-text');
                triggerText.textContent = 'Select category';
                triggerText.classList.add('placeholder');
                return;
            }

            const category = categories.find(c => c.id === parseInt(categoryId));
            if (category) {
                selectedCategoryId = category.id;
                document.getElementById('check-category').value = category.id;
                const triggerText = document.getElementById('category-trigger-text');
                triggerText.textContent = `${category.icon || 'üìÅ'} ${category.name}`;
                triggerText.classList.remove('placeholder');

                // If this is a child, select its parent in the left panel
                if (category.parent_id) {
                    selectParentCategory(category.parent_id);
                } else {
                    selectParentCategory(category.id);
                }
            }
        }

        // Render checks list
        function renderChecks() {
            const container = document.getElementById('checks-list');
            const checks = checksData?.checks || [];

            if (checks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div>No checks found</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = checks.map(check => `
                <div class="check-item" onclick="editCheck(${check.id})">
                    <div class="check-item-header">
                        <span class="check-item-number">#${check.check_number}</span>
                        <span class="check-item-amount">${formatCurrency(check.amount)}</span>
                    </div>
                    <div class="check-item-payee">${check.payee}</div>
                    <div class="check-item-meta">
                        <span>${formatDate(check.check_date)}</span>
                        <span class="status-badge ${check.status}">${check.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // Update summary stats
        function updateSummary() {
            const summary = checksData?.summary || {};
            document.getElementById('pending-count').textContent = summary.pending_count || 0;
            document.getElementById('pending-amount').textContent = formatCurrency(summary.pending_amount || 0);
        }

        // Filter checks
        function filterChecks(status, element) {
            currentFilter = status;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            if (element) element.classList.add('active');
            loadChecks();
        }

        // Update next check number
        function updateNextCheckNumber() {
            const accountId = document.getElementById('bank-account').value;
            if (accountId && nextCheckNumbers[accountId]) {
                document.getElementById('check-number').value = nextCheckNumbers[accountId];
            } else if (accountId) {
                document.getElementById('check-number').value = '1001';
            }
        }

        // Number to words conversion
        function numberToWords(amount) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
                         'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
                         'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

            const dollars = Math.floor(amount);
            const cents = Math.round((amount - dollars) * 100);

            function convertHundreds(num) {
                if (num === 0) return '';
                if (num < 20) return ones[num];
                if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 ? '-' + ones[num % 10] : '');
                return ones[Math.floor(num / 100)] + ' Hundred' + (num % 100 ? ' ' + convertHundreds(num % 100) : '');
            }

            function convert(num) {
                if (num === 0) return 'Zero';
                if (num < 1000) return convertHundreds(num);
                if (num < 1000000) {
                    return convertHundreds(Math.floor(num / 1000)) + ' Thousand' +
                           (num % 1000 ? ' ' + convertHundreds(num % 1000) : '');
                }
                return convertHundreds(Math.floor(num / 1000000)) + ' Million' +
                       (num % 1000000 ? ' ' + convert(num % 1000000) : '');
            }

            return convert(dollars) + ' and ' + cents.toString().padStart(2, '0') + '/100';
        }

        // Update amount words
        function updateAmountWords() {
            const amount = parseFloat(document.getElementById('check-amount').value) || 0;
            document.getElementById('amount-words').value = numberToWords(amount);
        }

        // Toggle checkbox
        function toggleCheckbox(el) {
            el.classList.toggle('checked');
            document.getElementById('create-transaction').value = el.classList.contains('checked') ? '1' : '0';
        }

        // Save check
        async function saveCheck(e) {
            e.preventDefault();

            const data = {
                user_id: USER_ID,
                account_id: parseInt(document.getElementById('bank-account').value),
                check_number: document.getElementById('check-number').value,
                payee: document.getElementById('check-payee').value,
                amount: parseFloat(document.getElementById('check-amount').value),
                check_date: document.getElementById('check-date').value,
                memo: document.getElementById('check-memo').value,
                address: document.getElementById('check-address').value,
                category_id: document.getElementById('check-category').value || null,
                status: document.getElementById('check-status').value,
                create_transaction: document.getElementById('create-transaction').value === '1'
            };

            const checkId = document.getElementById('check-id').value;
            if (checkId) {
                data.id = parseInt(checkId);
            }

            try {
                const response = await fetch(`${API_BASE}/checks/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    resetForm();
                    loadChecks();
                } else {
                    alert(result.message || 'Error saving check');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving check');
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('check-id').value = '';
            document.getElementById('bank-account').value = '';
            document.getElementById('check-number').value = '';
            document.getElementById('check-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('check-payee').value = '';
            document.getElementById('check-amount').value = '';
            document.getElementById('check-memo').value = '';
            document.getElementById('check-address').value = '';
            setCategoryValue(null); // Reset category dropdown
            document.getElementById('check-status').value = 'pending';
            document.getElementById('amount-words').value = 'Zero and 00/100';
            document.getElementById('transaction-checkbox').classList.add('checked');
            document.getElementById('create-transaction').value = '1';
            document.getElementById('delete-btn').style.display = 'none';
        }

        // Edit check
        function editCheck(id) {
            const check = checksData.checks.find(c => c.id === id);
            if (!check) return;

            document.getElementById('check-id').value = id;
            document.getElementById('bank-account').value = check.account_id;
            document.getElementById('check-number').value = check.check_number;
            document.getElementById('check-date').value = check.check_date;
            document.getElementById('check-payee').value = check.payee;
            document.getElementById('check-amount').value = check.amount;
            document.getElementById('check-memo').value = check.memo || '';
            document.getElementById('check-address').value = check.address || '';
            setCategoryValue(check.category_id); // Set category using new dropdown
            document.getElementById('check-status').value = check.status || 'pending';

            updateAmountWords();
            document.getElementById('delete-btn').style.display = 'inline-flex';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Delete check
        async function deleteCheck() {
            const checkId = document.getElementById('check-id').value;
            if (!checkId) return;

            const check = checksData.checks.find(c => c.id === parseInt(checkId));
            if (!confirm(`Delete Check #${check?.check_number || checkId}?`)) return;

            try {
                const response = await fetch(`${API_BASE}/checks/?id=${checkId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    resetForm();
                    loadChecks();
                } else {
                    alert(result.message || 'Error deleting check');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting check');
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
    </script>
</body>
</html>
